{% extends "base.html" %}
{% block title %}Преподаватель — Неделя{% endblock %}

{% block head %}
<style>
  :root{
    --accent:#cb1746;
    /* мягкие оттенки для таблиц в обеих темах */
    --tbl-head: color-mix(in srgb, var(--bg) 70%, #000);
    --tbl-line: var(--bd);
    --glass-aura: color-mix(in srgb, var(--accent) 10%, transparent);
    --chip-bg: color-mix(in srgb, var(--bg) 70%, #fff);
    --chip-bd: color-mix(in srgb, var(--bd) 70%, var(--accent) 0%);
    --chip-on: color-mix(in srgb, var(--accent) 16%, transparent);
    --remote-bg: color-mix(in srgb, var(--accent) 12%, transparent);
    --break-bg: color-mix(in srgb, var(--bg) 86%, #000);
    --ongo-bg: color-mix(in srgb, #22c55e 12%, transparent);
    --past-bg: color-mix(in srgb, #6b7280 10%, transparent);
    --up-bg: color-mix(in srgb, #60a5fa 12%, transparent);
  }
  /* === контейнер === */
  .t-wrap{ display:grid; gap:12px; }
  .bar{
    display:flex; flex-wrap:wrap; gap:10px; align-items:end;
    background: var(--glass); border:1px solid var(--glass-bd); border-radius:12px; padding:12px;
    box-shadow: 0 10px 26px rgba(0,0,0,.06), 0 0 0 1px color-mix(in srgb, var(--accent) 8%, transparent) inset;
  }
  .bar .field{ display:flex; flex-direction:column; gap:6px; }
  .bar label{ font-size:12px; color:var(--muted); }
  .bar input[type="date"], .bar select{
    padding:10px 12px; border-radius:10px; border:1px solid var(--bd); background:var(--card); color:var(--text);
    min-width: 180px;
  }
  .bar button{
    padding:10px 14px; border-radius:10px; border:1px solid color-mix(in srgb, var(--accent) 56%, var(--bd));
    background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 12%, #fff), var(--card));
    color: var(--text); font-weight:600; cursor:pointer;
    box-shadow: 0 1px 0 rgba(255,255,255,.25) inset;
  }
  .stat{
    padding:10px 12px; border-radius:10px; border:1px solid var(--glass-bd);
    background: var(--glass); color:var(--text);
  }

  /* === день === */
  .day{
    border:1px solid var(--bd); border-radius:14px; overflow:hidden; background:var(--card);
    box-shadow: 0 8px 24px rgba(0,0,0,.06), 0 0 0 1px color-mix(in srgb, var(--accent) 7%, transparent) inset;
  }
  .day-h{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px 12px; background: var(--glass-aura);
    border-bottom:1px solid var(--bd);
  }
  .day-h strong{ font-size:16px; }
  .day-h .muted{ color:var(--muted); }

  /* === таблица === */
  .tablewrap{ overflow:auto; }
  table.t{ width:100%; border-collapse:separate; border-spacing:0; }
  .t th, .t td{
    padding:10px 12px; border-bottom:1px solid var(--tbl-line); text-align:left; white-space:nowrap;
  }
  .t th{ position:sticky; top:0; background:var(--tbl-head); color:var(--text); font-weight:700; z-index:1; }
  .t tr:last-child td{ border-bottom:0; }
  .num{ width:58px; text-align:center; }
  .time{ width:110px; font-variant-numeric: tabular-nums; color:var(--muted); }
  .room{ width:220px; }

  /* состояния строк */
  .tr-remote{ background: var(--remote-bg); }
  .tr-ongo{ background: var(--ongo-bg); }
  .tr-past{ background: var(--past-bg); }
  .tr-up{ background: var(--up-bg); }
  .tr-break td{
    background: var(--break-bg);
    border-top: 1px dashed var(--tbl-line);
    border-bottom: 1px dashed var(--tbl-line);
    color: var(--muted);
    font-style: italic;
  }

  /* бейдж-пилюля */
  .chip{
    display:inline-flex; align-items:center; gap:6px; height:30px; padding:0 10px;
    border:1px solid var(--chip-bd); background: var(--chip-bg); border-radius:999px; font-size:12px;
  }
  .chip.on{ background: var(--chip-on); border-color: color-mix(in srgb, var(--accent) 40%, var(--bd)); }

  /* кнопки-иконки в таблице */
  .tbl-actions{ display:flex; gap:8px; }
  .btn-sm{
    padding:6px 10px; border-radius:8px; border:1px solid var(--bd); background:var(--card); cursor:pointer;
  }

  /* выходной */
  .holiday{
    padding:16px; text-align:center; color:var(--muted); background:var(--glass);
  }

  /* мобильчик */
  @media (max-width: 880px){
    .bar{ gap:8px; }
    .bar .field{ width: calc(50% - 6px); }
    .bar .field.full{ width:100%; }
    .bar input[type="date"], .bar select{ min-width: unset; }
    .day-h strong{ font-size:15px; }
    .tablewrap{ -webkit-overflow-scrolling: touch; }
    .time{ width:92px; }
    .room{ width:180px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="t-wrap">
  <!-- панель фильтров -->
  <div class="bar">
    <div class="field">
      <label>Начало</label>
      <input type="date" id="start">
    </div>
    <div class="field">
      <label>Конец</label>
      <input type="date" id="end">
    </div>
    <div class="field">
      <label>Группа</label>
      <select id="fltGroup">
        <option value="">Все группы</option>
      </select>
    </div>
    <button id="btnShow">Показать</button>
    <div class="field full">
      <div id="stats" class="stat">Загрузка…</div>
    </div>
  </div>

  <!-- календарь -->
  <div id="calendar" class="t-days"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ===== helpers ===== */
function fmt(d){ return d.toISOString().slice(0,10); }
function weekdayRu(dateStr){
  const map=['воскресенье','понедельник','вторник','среда','четверг','пятница','суббота'];
  const d=new Date(dateStr+'T00:00:00'); return map[d.getDay()];
}
function ddmmyyyy(dateStr){ const [y,m,d]=dateStr.split('-'); return `${d}.${m}.${y}`; }
function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }

/* Калининградское "сейчас" (для статуса строк) */
function nowInKgd(){
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone:'Europe/Kaliningrad',
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', hour12:false
  }).formatToParts(new Date());
  const get=t=>parts.find(p=>p.type===t).value;
  return { date:`${get('year')}-${get('month')}-${get('day')}`, hm:`${get('hour')}:${get('minute')}` };
}
function parseHHMMrange(s){
  if(!s) return {start:"00:00", end:"23:59"};
  const m=String(s).match(/(\d{1,2}):(\d{2}).*?(\d{1,2}):(\d{2})/);
  if(!m) return {start:"00:00", end:"23:59"};
  const P=x=>String(x).padStart(2,'0');
  return {start:`${P(m[1])}:${m[2]}`, end:`${P(m[3])}:${m[4]}`};
}
function cmpHM(a,b){ return a===b?0:(a<b?-1:1); }

/* ===== default week range ===== */
function setDefaultRange(){
  const now=new Date(); const day=now.getDay(); const diffToMon=(day+6)%7;
  const start=new Date(now); start.setDate(now.getDate()-diffToMon);
  const end=new Date(start); end.setDate(start.getDate()+6);
  document.getElementById('start').value = fmt(start);
  document.getElementById('end').value   = fmt(end);
}
setDefaultRange();

document.getElementById('btnShow').addEventListener('click', loadAll);

/* динамически наполняем селект групп после первой загрузки */
function fillGroupFilter(days){
  const sel=document.getElementById('fltGroup');
  const before = sel.value;
  const set=new Set();
  for(const d of days){
    for(const it of (d.items||[])){
      if(!it.break && it.group) set.add(it.group);
    }
  }
  const current = sel.value;
  sel.innerHTML = `<option value="">Все группы</option>` + [...set].sort().map(g=>`<option>${g}</option>`).join('');
  if([...set].includes(before)) sel.value = before;
}

/* Нормализация дня:
   - удаляем «перерыв» если он не между двумя занятиями
   - можно фильтровать по группе
   - если занятий не осталось — выставляем holiday
*/
function normalizeDay(day, groupFilter){
  let items = (day.items||[]).slice();
  if(groupFilter){
    items = items.filter(it => it.break ? true : (String(it.group||"")===groupFilter));
  }
  const lessonIdx = items.map((it,i)=>!it.break?i:null).filter(i=>i!==null);
  const out=[];
  for(let i=0;i<items.length;i++){
    const it=items[i];
    if(!it.break){ out.push(it); continue; }
    const hasPrev = lessonIdx.some(idx=>idx<i);
    const hasNext = lessonIdx.some(idx=>idx>i);
    if(hasPrev && hasNext) out.push(it);  // только между занятиями
  }
  const hasLesson = out.some(x=>!x.break);
  return { date: day.date, items: out, holiday: !hasLesson };
}

/* Для строки статуса: past / ongoing / upcoming */
function rowState(item, dayDate){
  const {date:today, hm} = nowInKgd();
  const {start,end} = parseHHMMrange(item.time);
  if(dayDate < today) return 'tr-past';
  if(dayDate > today) return 'tr-up';
  if(cmpHM(hm,end) > 0) return 'tr-past';
  if(cmpHM(hm,start) < 0) return 'tr-up';
  return 'tr-ongo';
}

/* ====== RENDER ====== */
function render(days){
  const wrap=document.getElementById('calendar');
  const groupFilter=document.getElementById('fltGroup').value;
  let html="";

  for(const dRaw of days){
    const day = normalizeDay(dRaw, groupFilter);
    const pairs = (day.items||[]).filter(x=>!x.break).length;

    html += `<div class="day">
      <div class="day-h">
        <strong>${weekdayRu(day.date)} • ${ddmmyyyy(day.date)}</strong>
        <span class="muted">${day.holiday ? "Выходной" : `${pairs} пар(ы)`}</span>
      </div>`;

    if(day.holiday){
      html += `<div class="holiday">Выходной</div></div>`;
      continue;
    }

    html += `<div class="tablewrap"><table class="t">
      <thead><tr>
        <th class="num">№</th>
        <th class="time">Время</th>
        <th>Группа</th>
        <th>Дисциплина</th>
        <th>Тип</th>
        <th class="room">Аудитория / Платформа</th>
        <th>ДЗ</th>
        <th>ID</th>
        <th>Действия</th>
      </tr></thead><tbody>`;

    for(const it of day.items){
      if(it.break){
        html += `<tr class="tr-break">
          <td class="num">${it.order}</td>
          <td class="time">${it.time||""}</td>
          <td colspan="7">Перерыв</td>
        </tr>`;
        continue;
      }
      const isRemote = !!it.is_remote;
      const rowCls = rowState(it, day.date) + (isRemote? ' tr-remote':'');
      const room = isRemote ? (it.remote_platform||"СДО") : (it.room || "—");
      const actions = `
        <div class="tbl-actions">
          <button class="btn-sm" onclick="uiSetHw(${it.id})" title="Домашнее задание">ДЗ</button>
          <button class="btn-sm" onclick="uiChangeRoom(${it.id})" title="Сменить кабинет">Каб.</button>
        </div>`;

      html += `<tr class="${rowCls}">
        <td class="num">${it.order}</td>
        <td class="time">${it.time||""}</td>
        <td>${it.group||""}</td>
        <td>${it.discipline||""}</td>
        <td>${it.lesson_type||""}</td>
        <td class="room">${room}</td>
        <td>${it.homework||""}</td>
        <td>${it.id||""}</td>
        <td>${actions}</td>
      </tr>`;
    }

    html += `</tbody></table></div></div>`;
  }
  wrap.innerHTML = html || `<div class="holiday">Нет данных за выбранный период</div>`;
}

/* ====== API ====== */
async function loadAll(){
  const start = document.getElementById('start').value;
  const end   = document.getElementById('end').value;

  // Статистика
  const s = await fetch(`/api/teacher/me/stats/?start=${start}&end=${end}`, {credentials:"same-origin"});
  if(!s.ok){
    document.getElementById('stats').textContent = "Нет доступа или ошибка";
  }else{
    const stats = await s.json();
    document.getElementById('stats').innerHTML =
      `Пары: <b>${stats.total_lessons}</b> • Часы: <b>${stats.total_hours}</b> • Рабочих дней: <b>${stats.working_days}</b>`;
  }

  // Расписание
  const r = await fetch(`/api/teacher/me/schedule/?start=${start}&end=${end}`, {credentials:"same-origin"});
  let data = await r.json();
  // убедимся, что пришёл массив [{date, items}]
  if(!Array.isArray(data)) data = [];

  // Заполним фильтр группами
  fillGroupFilter(data);

  render(data);
}

/* ====== действия в таблице ====== */
async function uiSetHw(lessonId){
  const text = prompt("Текст ДЗ для занятия #"+lessonId+":", "");
  if(text===null) return;
  const form = new FormData(); form.append("lesson_id", lessonId); form.append("text", text);
  const r = await fetch("/api/teacher/homework/set/", {
    method:"POST", body:form, credentials:"same-origin",
    headers:{"X-CSRFToken": getCookie("csrftoken")}
  });
  alert(await r.text());
  loadAll();
}
async function uiChangeRoom(lessonId){
  const r = await fetch(`/api/teacher/room/free/?lesson_id=${lessonId}`, {credentials:"same-origin"});
  if(!r.ok){ return alert(await r.text()); }
  const data = await r.json();
  if(!data.length){ return alert("Свободных кабинетов нет"); }
  const choice = prompt(
    "Введите room_id из списка:\n" +
    data.map(x=>`${x.id}: ${x.building} · ${x.name} (мест:${x.capacity}${x.computers?(", ПК:"+x.computers):""})`).join("\n")
  );
  if(!choice) return;
  const form = new FormData(); form.append("lesson_id", lessonId); form.append("room_id", choice);
  const r2 = await fetch("/api/teacher/room/change/", {
    method:"POST", body:form, credentials:"same-origin",
    headers:{"X-CSRFToken": getCookie("csrftoken")}
  });
  alert(await r2.text());
  loadAll();
}

/* автостарт */
loadAll();
</script>
{% endblock %}