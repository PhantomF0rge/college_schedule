{% extends "base.html" %}
{% block title %}Преподаватель — Неделя{% endblock %}

{% block content %}
<div class="card">
  <h1>Моё расписание (неделя)</h1>
  <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
    <label>Начало: <input type="date" id="start"></label>
    <label>Конец: <input type="date" id="end"></label>
    <button onclick="loadAll()">Показать</button>
  </div>

  <div id="stats" class="muted" style="margin-bottom:10px;"></div>
  <div id="calendar"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function fmt(d){ return d.toISOString().slice(0,10); }
function defaultRange(){
  const now = new Date(); const day = now.getDay(); const diffToMon = (day+6)%7;
  const start = new Date(now); start.setDate(now.getDate()-diffToMon);
  const end = new Date(start); end.setDate(start.getDate()+6);
  document.getElementById('start').value = fmt(start);
  document.getElementById('end').value = fmt(end);
}
defaultRange();

function getCookie(name){
  const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

async function loadAll(){
  const start = document.getElementById('start').value;
  const end   = document.getElementById('end').value;

  const s = await fetch(`/api/teacher/me/stats/?start=${start}&end=${end}`, {credentials:"same-origin"});
  if(!s.ok){ document.getElementById('stats').textContent = "Нет доступа или ошибка"; return; }
  const stats = await s.json();
  document.getElementById('stats').innerHTML =
    `Пары: <b>${stats.total_lessons}</b> • Часы: <b>${stats.total_hours}</b> • Рабочих дней: <b>${stats.working_days}</b>`;

  const r = await fetch(`/api/teacher/me/schedule/?start=${start}&end=${end}`, {credentials:"same-origin"});
  const data = await r.json();

  let html = "";
  for(const day of data){
    html += `<h2>${day.date}</h2><table>
      <tr><th>№</th><th>Время</th><th>Группа</th><th>Дисциплина</th><th>Тип</th><th>Кабинет</th><th>ДЗ</th><th>ID</th><th>Действия</th></tr>`;
    for(const item of day.items){
      if(item.break){
        html += `<tr class="break"><td>${item.order}</td><td>${item.time}</td><td colspan="7">Перерыв</td><td></td></tr>`;
      }else{
        const cls = item.badge || item.status;
        const room = item.is_remote ? `Дистанционно (${item.remote_platform||"—"})` : (item.room||"—");
        const actions = `
          <button onclick="uiSetHw(${item.id})" title="Домашнее задание">ДЗ</button>
          <button onclick="uiChangeRoom(${item.id})" title="Сменить кабинет">Каб.</button>`;
        html += `<tr class="${cls}">
          <td>${item.order}</td><td>${item.time}</td><td>${item.group}</td>
          <td>${item.discipline}</td><td>${item.lesson_type||""}</td>
          <td>${room}</td><td>${item.homework||""}</td><td>${item.id||""}</td>
          <td>${actions}</td>
        </tr>`;
      }
    }
    html += `</table>`;
  }
  document.getElementById("calendar").innerHTML = html;
}

async function uiSetHw(lessonId){
  const text = prompt("Текст ДЗ для занятия #"+lessonId+":", "");
  if(text===null) return;
  const form = new FormData(); form.append("lesson_id", lessonId); form.append("text", text);
  const r = await fetch("/api/teacher/homework/set/", {method:"POST", body:form, credentials:"same-origin", headers:{"X-CSRFToken": getCookie("csrftoken")}});
  alert(await r.text());
  loadAll();
}

async function uiChangeRoom(lessonId){
  const r = await fetch(`/api/teacher/room/free/?lesson_id=${lessonId}`, {credentials:"same-origin"});
  if(!r.ok){ return alert(await r.text()); }
  const data = await r.json();
  if(!data.length){ return alert("Свободных кабинетов нет"); }
  const choice = prompt("Введите room_id из списка:\n" + data.map(x=>`${x.id}: ${x.building} · ${x.name} (мест:${x.capacity}${x.computers?(", ПК:"+x.computers):""})`).join("\n"));
  if(!choice) return;
  const form = new FormData(); form.append("lesson_id", lessonId); form.append("room_id", choice);
  const r2 = await fetch("/api/teacher/room/change/", {method:"POST", body:form, credentials:"same-origin", headers:{"X-CSRFToken": getCookie("csrftoken")}});
  alert(await r2.text());
  loadAll();
}

loadAll();
</script>
{% endblock %}
